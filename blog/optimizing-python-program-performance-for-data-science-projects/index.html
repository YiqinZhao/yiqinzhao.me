<html><style>body{margin:0}img{width:100%}a{color:var(--font-color)}</style><head><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta charset="utf-8"><link rel="stylesheet" href="/assets/css/base.css"><link rel="stylesheet" href="/assets/css/prism-theme.css"><link rel="stylesheet" href="/assets/css/dark-mode.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css"><title>Optimizing Python Program Performance for Data Science Projects | Yiqin Zhao</title><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="apple-mobile-web-app-title" content="YiqinZhao"><meta name="msapplication-TileColor" content="#ffffff"><meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#0a0a0a" media="(prefers-color-scheme: dark)"><link rel="apple-touch-icon" sizes="180x180" href="/assets/site-icons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/site-icons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/site-icons/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="shortcut icon" href="/assets/site-icons/favicon.ico" type="image/x-icon"><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-4SWJ9K37XN"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-4SWJ9K37XN")</script></head><style>.title{font-size:3rem;font-weight:700;margin:0 0 10px 0}.meta-row{border-bottom:1px dashed var(--line-color);margin-bottom:20px;opacity:.7;font-style:italic;flex-wrap:wrap;padding:10px 0}.meta-row>*{line-height:1.5rem}.date{margin-right:.5rem}.tag{margin-right:.5rem}.hero-wrapper{background-color:#f4f5f7;padding:0 0 40px 0}.hero-container{padding:20px 0;position:relative;align-items:flex-start}.markdown strong>img{border:1px solid rgba(0,0,0,.6)}@media (max-width:480px){.meta-row{flex-wrap:wrap}}@media (prefers-color-scheme:dark){.label-icon{filter:invert(1)}.markdown strong>img{filter:invert(.85)}}</style><body><header><style>.nav-container{width:100%;height:60px;padding:20px 0;background-color:transparent;display:flex;flex-direction:row;align-items:center;justify-content:space-between}.logo{font-size:1.5rem;font-weight:700;opacity:.7;cursor:pointer;color:var(--font-color);transition:opacity .1s linear}.logo:hover{opacity:1}.menu-item{font-size:1.3rem;font-weight:700;opacity:.7;text-transform:capitalize;margin:0 17px;padding:0 5px;cursor:pointer;transition:opacity .1s linear,border-bottom .1s linear}.menu-item:hover{opacity:1;border-bottom:3px solid #979797}.menu-item-active{opacity:1;border-bottom:3px solid #979797}.menu-item:nth-last-child(1){margin-right:0}.menu-row>a{color:var(--font-color)}.menu-row>a:hover{text-decoration:none}.menu-button{display:none}.mobile-nav{width:100%;display:none}@media (prefers-color-scheme:dark){#menu-button-icon{filter:invert()}}@media (min-width:320px) and (max-width:768px){body{padding-top:61px}.hero-header{overflow:hidden}.logo{display:none}.nav-container{padding:0 0;position:fixed;top:0;border-bottom:.5px solid #636363;z-index:1;justify-content:flex-end;background-color:var(--front-color)}.menu-item-active{border-bottom:none}.menu-button{display:block;margin-right:20px}#menu-button-icon{height:17px;width:24px}.mobile-nav{height:60px;display:flex}.mobile-nav>.nav-title{font-size:1.3rem;font-weight:700;text-transform:capitalize;margin:0 17px;padding:0 5px}.nav-container{height:auto;flex-direction:column}.menu-row{padding:5px 0;flex-wrap:wrap;overflow:hidden;justify-content:space-between}.hide-menu-row{height:0;padding:0}.menu-row>.menu-item{margin:10px 17px}}</style><div class="nav-container"><a class="logo" href="/" style="visibility:visible">Yiqin Zhao</a><div class="mobile-nav stack" horizontal-layout="space-between" vertical-layout="center"><div class="stack nav-title">blog</div><div class="menu-button" onclick="onMenuButtonClick()"><img id="menu-button-icon" src="/assets/img/menu.svg" alt=""></div></div><div class="stack menu-row hide-menu-row"><a class="menu-item" href="/">home</a> <a class="menu-item" href="/news/">news</a> <a class="menu-item" href="/project/">project</a> <a class="menu-item" href="/publication/">publication</a> <a class="menu-item menu-item-active" href="/blog/">blog</a> <a class="menu-item" href="/assets/yiqinzhao-cv.pdf">CV</a></div></div><script>function onMenuButtonClick(){let e=document.querySelector(".menu-row").classList;e.contains("hide-menu-row")?(e.remove("hide-menu-row"),document.querySelector("#menu-button-icon").setAttribute("src","/assets/img/close.svg")):(e.add("hide-menu-row"),document.querySelector("#menu-button-icon").setAttribute("src","/assets/img/menu.svg"))}</script></header><article class="stack" direction="column"><div class="stack" direction="column"><div class="title">Optimizing Python Program Performance for Data Science Projects</div><div class="stack meta-row" vertical-layout="center"><div class="date">Oct 2, 2020</div><span class="tag stack" vertical-layout="center"><img class="vector-image" src="/assets/icons/tag.svg" alt=""> Python </span><span class="tag stack" vertical-layout="center"><img class="vector-image" src="/assets/icons/tag.svg" alt=""> Optimization</span><div class="eta">ETA: 3min(s)</div></div></div><div class="markdown"><p>In this article, I will introduce some handful Python data science program optimization tips. I will try to cover the most commonly seen scenarios in data science projects. Specially, although the rapid evolution of data science toolkit brought promising program performance to developers, there are still many hidden rabbit holes that may causes significant performance issues. This article will also provide insights and examples for helping you avoid making such mistakes in your program. This article is very readable, and does not assume you have a strong computer system/architecture background.</p><h1 id="%F0%9F%A7%B5%F0%9F%A7%B5%F0%9F%A7%B5-instant-boost-with-multi-threading">🧵🧵🧵 Instant Boost with Multi-threading</h1><p>Modern computer CPUs commonly have multiple cores, however, Python program could only use one core by default. For some tasks, simply replacing a <code>for</code> loop with multi-threading code could result in a pretty decent performance improvement. Let's take a look at an example:</p><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> glob

files <span class="token operator">=</span> glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'./data/*/*.npy'</span><span class="token punctuation">)</span>
<span class="token comment"># files = [</span>
<span class="token comment">#   './data/0/train.npy',</span>
<span class="token comment">#   './data/0/label.npy',</span>
<span class="token comment">#   './data/1/train.npy',</span>
<span class="token comment">#   './data/1/label.npy',</span>
<span class="token comment">#   ...</span>
<span class="token comment"># ]</span>

<span class="token keyword">for</span> f <span class="token keyword">in</span> files<span class="token punctuation">:</span>
    output <span class="token operator">=</span> some_operation<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
    <span class="token comment"># ...</span>
</code></pre><p>The above code snippet applies an external function <code>some_operation</code> to a series of NumPy arrays loaded from file system. Let's imagine if you have a large amount of files need to be processed, the above code could potentially be really slow. A very likely performance bottleneck is the Python single thread feature. While, to leverage multi-threading for improving your code performance, we need to do a little bit change on the original code:</p><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> glob
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool


<span class="token keyword">def</span> <span class="token function">processor</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output <span class="token operator">=</span> some_operation<span class="token punctuation">(</span>f<span class="token punctuation">)</span>

    <span class="token comment"># ...</span>

    <span class="token comment"># If you need the output, you can return it.</span>
    <span class="token comment"># And the returned output will be ordered</span>
    <span class="token comment"># as the input.</span>
    <span class="token keyword">return</span> output

files <span class="token operator">=</span> glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'./data/*/*.npy'</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> Pool<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment"># Number of CPU cores</span>
outputs <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>processor<span class="token punctuation">,</span> files<span class="token punctuation">)</span>
</code></pre><p>The above code replaced the <code>for</code> loop body with a function <code>processor</code>, then map all files into multi threads processing through the <code>map</code> function. Here you wanna maximize the utilization of your CPU resources by assign as many threads as your CPU cores. The <code>multiprocessing</code> is a built-in module that came with most python distribution, which means you are likely to use it without pip install.</p><p><em>Note: the Python's &quot;multi-threading&quot; feature is actually implemented as &quot;multi-processing&quot;. Which means it will spawn multiple processes for your program instead of running multiple threads in a single process. More technical details refer to <a href="https://timber.io/blog/multiprocessing-vs-multithreading-in-python-what-you-need-to-know/">here</a>.</em></p><p>Apparently, you might want to ask: <strong>when should I use multi-threading?</strong> This is a very good one. Typically, for computation bounded tasks, e.g. calculation, multi-threading typically works well. And you are likely to see a linear style performance increase. However, for I/O bounded tasks, e.g. file read/write, multi-threading does not work very well, because the major performance bottle typically came from disk I/O speed. If your task can be break down into <strong>small</strong>, <strong>independent</strong> and <strong>CPU bounded</strong> subtasks, uses the multi-threading.</p><hr><p><strong>I'm rewriting the whole article, please stay tuned.</strong></p><h1 id="%F0%9F%94%A2-tensor-operation-broadcasting">🔢 Tensor Operation Broadcasting</h1><h1 id="%F0%9F%90%8E-unleash-the-power-of-gpu">🐎 Unleash the Power of GPU</h1><h1 id="%F0%9F%94%A5-rebirth-in-c%2B%2B">🔥 Rebirth in C++</h1></div></article><style>.foot{opacity:.6;border-top:1px solid var(--line-color);margin-top:20px;padding:20px 0;font-size:.8rem}.foot a{color:var(--font-color);text-decoration:underline}</style><footer class="stack foot" direction="column" horizontal-layout="center"><span>© <a href="/">Yiqin Zhao</a> 2022. Last Updated: Feb 27, 2022</span> <span>Proudly Powered by <a href="https://github.com/YiqinZhao/Ploceus">Ploceus</a></span></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js" integrity="sha512-AA1Bzp5Q0K1KanKKmvN/4d3IRKVlv9PYgwFPvm32nPO6QS8yH1HO7LbgB1pgiOxPtfeg5zEn2ba64MUcqJx6CA==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js" integrity="sha512-nOQuvD9nKirvxDdvQ9OMqe2dgapbPB7vYAMrzJihw5m+aNcf0dX53m6YxM4LgA9u8e9eg9QX+/+mPu8kCNpV2A==" crossorigin="anonymous"></script><script>window.addEventListener("load",function(){document.querySelectorAll(".encrypted").forEach(e=>{e.addEventListener("click",function(){this.classList.contains("encrypted")&&swal("Password",{content:"input"}).then(t=>{let e=this;for(;!e.classList.contains("markdown");)e=e.parentNode;e.querySelectorAll(".encrypted").forEach(e=>{e.innerHTML=CryptoJS.AES.decrypt(e.innerHTML,t).toString(CryptoJS.enc.Utf8),e.classList.remove("encrypted"),e.classList.add("decrypted")})})})})})</script></body><script>let themeString="github-";window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?themeString+="dark":themeString+="light";const scriptTag=document.createElement("script");scriptTag.setAttribute("src","https://utteranc.es/client.js"),scriptTag.setAttribute("repo","YiqinZhao/yiqinzhao.me"),scriptTag.setAttribute("issue-term","title"),scriptTag.setAttribute("label","Comment"),scriptTag.setAttribute("theme",themeString),scriptTag.setAttribute("crossorigin","anonymous"),scriptTag.async=!0,document.getElementsByTagName("article")[0].appendChild(scriptTag)</script></html>